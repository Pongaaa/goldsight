<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goldsight - Giá Vàng SJC & Thế Giới</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Animation nhấp nháy cho tín hiệu Live */
        @keyframes pulse-green { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .live-dot { animation: pulse-green 2s infinite; }
    </style>
</head>
<body class="bg-gray-100 text-slate-800 font-sans">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-yellow-500 text-2xl"></i>
                <span class="text-xl font-bold tracking-tight text-slate-800">Goldsight</span>
            </div>
            <div class="flex items-center gap-2 text-xs font-semibold text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-200">
                <span class="w-2 h-2 bg-green-500 rounded-full live-dot"></span>
                Hệ thống Online
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">

        <section class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="tradingview-widget-container" style="height: 450px; width: 100%;">
                <div class="tradingview-widget-container__widget" style="height: calc(100% - 32px); width: 100%;"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                {
                    "autosize": true,
                    "symbol": "OANDA:XAUUSD",
                    "interval": "15",
                    "timezone": "Asia/Ho_Chi_Minh",
                    "theme": "light",
                    "style": "1",
                    "locale": "vi_VN",
                    "enable_publishing": false,
                    "hide_top_toolbar": false,
                    "allow_symbol_change": false,
                    "calendar": false,
                    "support_host": "https://www.tradingview.com"
                }
                </script>
            </div>
        </section>

        <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-2">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-money-bill-trend-up text-yellow-500"></i> Giá Vàng SJC Hôm Nay
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Cập nhật tự động từ thị trường tự do</p>
                </div>
                <p class="text-xs text-gray-400 italic" id="update-time">Đang tải dữ liệu...</p>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-100">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider font-semibold">
                            <th class="p-4">Thương hiệu</th>
                            <th class="p-4 text-right">Giá Mua vào</th>
                            <th class="p-4 text-right">Giá Bán ra</th>
                        </tr>
                    </thead>
                    <tbody id="price-table-body" class="text-sm font-medium">
                        <tr>
                            <td colspan="3" class="p-8 text-center text-gray-400">
                                <i class="fa-solid fa-spinner fa-spin mr-2"></i> Đang kết nối tới Python Server...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <footer class="text-center py-8 text-gray-400 text-xs">
        <p>&copy; 2026 Goldsight Project. Dữ liệu mang tính chất tham khảo.</p>
    </footer>

    <script>
        // Hàm định dạng tiền: 186000000 -> 186.000.000
        const formatMoney = (amount) => {
            if (!amount) return "0";
            return new Intl.NumberFormat('vi-VN').format(amount);
        };

        // Hàm tạo nhãn tăng/giảm (Màu Xanh/Đỏ)
        const renderBadge = (changeObj) => {
            if (!changeObj.change) return ""; 

            const colorClass = changeObj.trend === 'up' ? 'text-green-700 bg-green-100 border-green-200' : 
                               (changeObj.trend === 'down' ? 'text-red-700 bg-red-100 border-red-200' : 'text-gray-500');
            
            return `<span class="ml-2 text-[11px] font-bold px-1.5 py-0.5 rounded border ${colorClass}">
                        ${changeObj.change}
                    </span>`;
        };

        async function fetchPrices() {
            try {
                // Gọi API Python
                const response = await fetch('http://127.0.0.1:8000/gia-vang');
                const data = await response.json();

                if (data.length > 0 && !data[0].error) {
                    renderTable(data);
                }
            } catch (error) {
                console.error("Lỗi kết nối:", error);
                document.getElementById('price-table-body').innerHTML = `
                    <tr><td colspan="3" class="p-6 text-center text-red-500">
                        <i class="fa-solid fa-triangle-exclamation mb-2"></i><br>
                        Chưa bật Backend! Hãy chạy lệnh <code>python main.py</code>
                    </td></tr>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('price-table-body');
            tbody.innerHTML = ''; 

            data.forEach((item, index) => {
                // Xen kẽ màu nền dòng chẵn lẻ
                const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                const row = `
                    <tr class="${rowBg} hover:bg-yellow-50 transition-colors border-b border-gray-100 last:border-0">
                        <td class="p-4 font-bold text-slate-700">
                            ${item.brand}
                        </td>
                        
                        <td class="p-4 text-right">
                            <div class="text-base text-slate-800 font-mono">
                                ${formatMoney(item.buy.price)} 
                                ${renderBadge(item.buy)}
                            </div>
                        </td>
                        
                        <td class="p-4 text-right">
                            <div class="text-base text-slate-900 font-bold font-mono">
                                ${formatMoney(item.sell.price)}
                                ${renderBadge(item.sell)}
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Lấy thời gian cập nhật từ bản ghi đầu tiên (hoặc giờ hiện tại)
            const updateTime = data[0].updated_at || new Date().toLocaleTimeString('vi-VN');
            document.getElementById('update-time').innerText = `Cập nhật lúc: ${updateTime}`;
        }

        // Tự động tải lại sau mỗi 10 giây
        fetchPrices();
        setInterval(fetchPrices, 10000); 

    </script>
</body>
</html>